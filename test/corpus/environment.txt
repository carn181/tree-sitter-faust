====
Declare environment
====

empty_env = environment {};
nonempty_env = environment {
  foo = 1;
  bar = foo,_;
};

---
(program
  (definition name: (id) value: (environment))
  (definition
    name: (id)
    value: (environment
      (definition name: (id) value: (int))
      (definition
        name: (id)
        value: (parallel left: (id) right: (wire))))))

====
Empty with environment
====

pink = f : + ~ g with {};
process = pink;

---
(program
  (definition
    name: (id)
    value: (with_environment
      expression: (sequential
        left: (id)
        right: (recursive left: (add) right: (id)))
      local_environment: (environment)))
  (definition name: (id) value: (id)))

====
With environment
====

pink = f : + ~ g with {
  f(x) = 0.04957526213389*x - 0.06305581334498*x' + 0.01483220320740*x'';
  g(x) = 1.80116083982126*x - 0.80257737639225*x';
};
process = pink;

---
(program
  (definition
    name: (id)
    value: (with_environment
      expression: (sequential
        left: (id)
        right: (recursive left: (add) right: (id)))
      local_environment: (environment
        (function_definition
          name: (id)
          (parameters (parameter))
          value: (infix
            left: (infix
              left: (infix left: (real) operator: (mult) right: (id))
              operator: (sub)
              right: (infix
                left: (real)
                operator: (mult)
                right: (modifier operand: (id) operator: (one_sample_delay))))
            operator: (add)
            right: (infix
              left: (real)
              operator: (mult)
              right: (modifier
                operand: (modifier operand: (id) operator: (one_sample_delay))
                operator: (one_sample_delay)))))
        (function_definition
          name: (id)
          (parameters (parameter))
          value: (infix
            left: (infix left: (real) operator: (mult) right: (id))
            operator: (sub)
            right: (infix
              left: (real)
              operator: (mult)
              right: (modifier operand: (id) operator: (one_sample_delay))))))))
  (definition name: (id) value: (id)))

====
letrec
====

ar(a,r,g) = v letrec {
  'n = (n+1) * c;
  'v = max(0, v + (n<a)/a - (n>=a)/r) * c; 
  where
      c = g<=g'; 
  };

---
(program
  (function_definition
    name: (id)
    (parameters (parameter) (parameter) (parameter))
    value: (letrec_environment
      expression: (id)
      local_environment: (rec_environment
        (recinition
          name: (id)
          expression: (infix
            left: (infix left: (id) operator: (add) right: (int))
            operator: (mult)
            right: (id)))
        (recinition
          name: (id)
          expression: (infix
            left: (prim2 primitive: (max)
              (arguments
                (int)
                (infix
                  left: (infix
                    left: (id)
                    operator: (add)
                    right: (infix
                      left: (infix left: (id) operator: (lt) right: (id))
                      operator: (div)
                      right: (id)))
                  operator: (sub)
                  right: (infix
                    left: (infix left: (id) operator: (ge) right: (id))
                    operator: (div)
                    right: (id)))))
            operator: (mult)
            right: (id)))
        (definition
          name: (id)
          value: (infix
            left: (id)
            operator: (le)
            right: (modifier operand: (id) operator: (one_sample_delay))))))))
